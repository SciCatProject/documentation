
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Jobs Â· SciCat Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 5.1.4">
        
        
        
    
    
    <link rel="stylesheet" href="../../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../../../styles/website.css">
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../authorization.html" />
    
    
    <link rel="prev" href="../configuration.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../../">
            
                <a href="../../../../">
            
                    
                    SciCat Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../../../Users/">
            
                <a href="../../../../Users/">
            
                    
                    User Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../../../Users/Anonymous.html">
            
                <a href="../../../../Users/Anonymous.html">
            
                    
                    Anonymous View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../../../Users/Login.html">
            
                <a href="../../../../Users/Login.html">
            
                    
                    Login
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../../../Users/Dashboard.html">
            
                <a href="../../../../Users/Dashboard.html">
            
                    
                    Dashboard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../../../Users/Dataset_Details.html">
            
                <a href="../../../../Users/Dataset_Details.html">
            
                    
                    Dataset Details
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../../../../Users/Dataset_Details_Files.html">
            
                <a href="../../../../Users/Dataset_Details_Files.html">
            
                    
                    Dataset Filelisting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../../../../Users/Dataset_Attachments.html">
            
                <a href="../../../../Users/Dataset_Attachments.html">
            
                    
                    Dataset Attachments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.3" data-path="../../../../Users/View_Raw_Metadata.html">
            
                <a href="../../../../Users/View_Raw_Metadata.html">
            
                    
                    View Raw JSON data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.4" data-path="../../../../Users/Edit_Scientific_Metadata.html">
            
                <a href="../../../../Users/Edit_Scientific_Metadata.html">
            
                    
                    Edit Scientific Metadata
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../../../../Users/Publishing.html">
            
                <a href="../../../../Users/Publishing.html">
            
                    
                    Dataset Publishing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../../../../Users/Jobs.html">
            
                <a href="../../../../Users/Jobs.html">
            
                    
                    Archival and Retrieval Jobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../../../../Users/SampleData.html">
            
                <a href="../../../../Users/SampleData.html">
            
                    
                    Sample Data Entry
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../../../Operator/">
            
                <a href="../../../../Operator/">
            
                    
                    Operator Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../../../Operator/Step_by_Step_Setup.html">
            
                <a href="../../../../Operator/Step_by_Step_Setup.html">
            
                    
                    Step by Step instruction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../../../Operator/Step_by_Step_Setup_Docker.html">
            
                <a href="../../../../Operator/Step_by_Step_Setup_Docker.html">
            
                    
                    Deploy with Docker Compose
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../../../../Operator/Step_by_Step_Setup_Kubernetes.html">
            
                <a href="../../../../Operator/Step_by_Step_Setup_Kubernetes.html">
            
                    
                    Deploy with Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../../../../Operator/Step_by_Step_Setup_Zip_Service.html">
            
                <a href="../../../../Operator/Step_by_Step_Setup_Zip_Service.html">
            
                    
                    Deploy Zip Service
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../../../Ingestor/README.md">
            
                <span>
            
                    
                    Ingestor Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../../../Ingestor/ingestManual.md">
            
                <span>
            
                    
                    Ingest Manual PSI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../../../Ingestor/IngestManual_ESS.md">
            
                <span>
            
                    
                    Ingest Instructions ESS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../../../../Ingestor/GettingMetadataIntoScicat.md">
            
                <span>
            
                    
                    Manual Ingest the Hard Way
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../../">
            
                <a href="../../../">
            
                    
                    Developers Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../../v3.x/">
            
                <a href="../../../v3.x/">
            
                    
                    v3.x
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="../../../v3.x/StartHere.html">
            
                <a href="../../../v3.x/StartHere.html">
            
                    
                    Overview of Backend and Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="../../../v3.x/Data_Model.html">
            
                <a href="../../../v3.x/Data_Model.html">
            
                    
                    An Introduction to the Data Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="../../../v3.x/Running.html">
            
                <a href="../../../v3.x/Running.html">
            
                    
                    Running the Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.4" data-path="../../../v3.x/Configuration.html">
            
                <a href="../../../v3.x/Configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.5" data-path="../../../v3.x/Theming.html">
            
                <a href="../../../v3.x/Theming.html">
            
                    
                    Theming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.6" data-path="../../../v3.x/Login.html">
            
                <a href="../../../v3.x/Login.html">
            
                    
                    Login and Accounts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.7" data-path="../../../v3.x/OIDC.html">
            
                <a href="../../../v3.x/OIDC.html">
            
                    
                    OIDC Integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.8" data-path="../../../v3.x/Ngrx.html">
            
                <a href="../../../v3.x/Ngrx.html">
            
                    
                    State Management in Angular
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.9" data-path="../../../v3.x/Testing_backend.html">
            
                <a href="../../../v3.x/Testing_backend.html">
            
                    
                    Testing Backend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.10" data-path="../../../v3.x/Testing.html">
            
                <a href="../../../v3.x/Testing.html">
            
                    
                    Testing Frontend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.11" data-path="../../../v3.x/Contributing.html">
            
                <a href="../../../v3.x/Contributing.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.12" data-path="../../../v3.x/Development_Methods.html">
            
                <a href="../../../v3.x/Development_Methods.html">
            
                    
                    Git Flow Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.13" data-path="../../../v3.x/Documentation.html">
            
                <a href="../../../v3.x/Documentation.html">
            
                    
                    Documentation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../../">
            
                <a href="../../">
            
                    
                    v4.x
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="../../overview.html">
            
                <a href="../../overview.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="../../backend_overview.html">
            
                <a href="../../backend_overview.html">
            
                    
                    Backend Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="../../contributing.html">
            
                <a href="../../contributing.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="../../developers_guide.html">
            
                <a href="../../developers_guide.html">
            
                    
                    Developer Guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="../../Data_Model.html">
            
                <a href="../../Data_Model.html">
            
                    
                    An Introduction to the Data Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="../../running.html">
            
                <a href="../../running.html">
            
                    
                    Running the Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7" data-path="../../configuration.html">
            
                <a href="../../configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.7.1" data-path="../configuration.html">
            
                <a href="../configuration.html">
            
                    
                    Backend
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.5.2.7.1.1" data-path="jobconfig.html">
            
                <a href="jobconfig.html">
            
                    
                    Jobs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2" data-path="../authorization.html">
            
                <a href="../authorization.html">
            
                    
                    Authorization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.7.2.1" data-path="../authorization/authorization_datasets.html">
            
                <a href="../authorization/authorization_datasets.html">
            
                    
                    Datasets
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2.2" data-path="../authorization/authorization_origdatablocks.html">
            
                <a href="../authorization/authorization_origdatablocks.html">
            
                    
                    OrigDatablocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2.3" data-path="../authorization/authorization_proposals.html">
            
                <a href="../authorization/authorization_proposals.html">
            
                    
                    Proposals
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2.4" data-path="../authorization/authorization_jobs.html">
            
                <a href="../authorization/authorization_jobs.html">
            
                    
                    Jobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2.5" data-path="../authorization/authorization_instruments.html">
            
                <a href="../authorization/authorization_instruments.html">
            
                    
                    Instruments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2.6" data-path="../authorization/authorization_users.html">
            
                <a href="../authorization/authorization_users.html">
            
                    
                    Users
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.2.7" data-path="../authorization/authorization_samples.html">
            
                <a href="../authorization/authorization_samples.html">
            
                    
                    Samples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.3" data-path="../../elasticsearch/elasticsearch.html">
            
                <a href="../../elasticsearch/elasticsearch.html">
            
                    
                    Elastic Search
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7.4" data-path="../../frontend/configuration.html">
            
                <a href="../../frontend/configuration.html">
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.8" data-path="../../Theming.md">
            
                <span>
            
                    
                    Theming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.9" data-path="../../Login.html">
            
                <a href="../../Login.html">
            
                    
                    Login and Accounts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.10" data-path="../../OIDC.md">
            
                <span>
            
                    
                    OIDC Integration
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.10.1" data-path="../../configuration_oidc.md">
            
                <span>
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.10.2" data-path="../configuration_oidc.html">
            
                <a href="../configuration_oidc.html">
            
                    
                    Backend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.11" data-path="../../testing.md">
            
                <span>
            
                    
                    Testing
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.11.1" data-path="../testing_backend.html">
            
                <a href="../testing_backend.html">
            
                    
                    Backend
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.11.1.1" data-path="../testing/instrument.html">
            
                <a href="../testing/instrument.html">
            
                    
                    Instrument
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.11.1.2" data-path="../testing/user_authorization.html">
            
                <a href="../testing/user_authorization.html">
            
                    
                    User Authorization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.11.1.3" data-path="../testing/dataset_authorization.html">
            
                <a href="../testing/dataset_authorization.html">
            
                    
                    Dataset Authorizatoin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.11.1.4" data-path="../testing/dataset_types.html">
            
                <a href="../testing/dataset_types.html">
            
                    
                    Dataset Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.11.1.5" data-path="../testing/sample_authorization.html">
            
                <a href="../testing/sample_authorization.html">
            
                    
                    Sample Authorization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.11.2" data-path="../../frontend/testing.md">
            
                <span>
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.12" data-path="../../Migration.html">
            
                <a href="../../Migration.html">
            
                    
                    Migration v3.x to v4.x
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../../../Documentation.html">
            
                <a href="../../../Documentation.html">
            
                    
                    Documentation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../../.." >Jobs</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="job-configuration">Job Configuration</h1>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#quick-start">Quick-start</a></li>
<li><a href="#details">Details</a><ul>
<li><a href="#job-lifecycle">Job lifecycle</a></li>
<li><a href="#referencing-datasets">Referencing datasets</a></li>
<li><a href="#status-codes">Status Codes</a></li>
<li><a href="#actions">Actions</a></li>
<li><a href="#migration-notes">Migration Notes</a></li>
</ul>
</li>
<li><a href="#configuration">Configuration</a><ul>
<li><a href="#configuration-overview">Configuration overview</a></li>
<li><a href="#authorization">Authorization</a></li>
<li><a href="#templates">Templates</a></li>
<li><a href="#actions-configuration">Actions Configuration</a><ul>
<li><a href="#urlaction">URLAction</a></li>
<li><a href="#validate">Validate</a><ul>
<li><a href="#example-1-require-extra-template-data">Example 1: Require extra template data</a></li>
<li><a href="#example-2-enforce-datasetlifecycle-state">Example 2: Enforce datasetLifecycle state</a></li>
<li><a href="#example-3-define-statuscodes">Example 3: Define statusCodes</a></li>
</ul>
</li>
<li><a href="#email">Email</a></li>
<li><a href="#rabbitmq">RabbitMQ</a></li>
<li><a href="#switch">Switch</a></li>
<li><a href="#error">Error</a></li>
<li><a href="#log">Log</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="overview">Overview</h2>
<p>The SciCat job system is used for any interactions between SciCat and external services.</p>
<p>Example jobs include:</p>
<ul>
<li>Request an <strong>archive system</strong> to <em>archive</em> or <em>retrieve</em> data from tape storage</li>
<li>Move data to a <em>public</em> location (e.g. to access data from a <a href="https://github.com/SciCatProject/LandingPageServer" target="_blank">DOI landing
page</a>)</li>
<li>Run maintenance tasks such as emailing users</li>
</ul>
<p>If you just plan to use SciCat for cataloging data and don't plan to use its data
management features then you may not need any job types. If no job types are configured
then SciCat will reject any backend requests to create jobs. In this case <a href="../../frontend/configuration.html">frontend
features</a> for archiving (<code>archiveWorkflowEnabled:
false</code>) and retrieval should be disabled.</p>
<h2 id="quick-start">Quick-start</h2>
<p>To start using jobs:</p>
<ol>
<li>Copy
<a href="https://github.com/SciCatProject/scicat-backend-next/blob/master/jobConfig.recommended.yaml" target="_blank"><code>jobConfig.recommended.yaml</code></a>
to <code>jobConfig.yaml</code></li>
<li>Update the configuration. See
<a href="https://github.com/SciCatProject/scicat-backend-next/blob/master/jobConfig.example.yaml" target="_blank">jobConfig.example.yaml</a>
and the <a href="#actions-configuration">Actions Configuration</a> section below for examples.</li>
<li>Set <code>JOB_CONFIGURATION_FILE=jobConfig.yaml</code> in your .env file or environment</li>
</ol>
<h2 id="details">Details</h2>
<h3 id="job-lifecycle">Job lifecycle</h3>
<p>Jobs follow a standard Create-Read-Update-Delete (CRUD) lifecycle:</p>
<ol>
<li><p>Jobs are <em>created</em> via a <code>POST</code> request to <code>/jobs</code>. This can be the result of a frontend
interaction (eg selecting a dataset for publishing) or through the REST API.</p>
<p>The body of the request should follow the CreateJobDto (Data Transfer Object):</p>
<pre><code class="lang-json">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"archive"</span>,
  <span class="hljs-string">"ownerUser"</span>: <span class="hljs-string">"owner"</span>,
  <span class="hljs-string">"ownerGroup"</span>: <span class="hljs-string">"group"</span>,
  <span class="hljs-string">"contactEmail"</span>: <span class="hljs-string">"email@example.com"</span>
  <span class="hljs-string">"jobParams"</span>: {}
}
</code></pre>
</li>
<li><p>Jobs can be <em>read</em> via a <code>GET</code> request to <code>/jobs/:id</code> or through the <code>/jobs/fullquery</code>
search endpoint. The frontend uses this to display the list of jobs.</p>
</li>
<li><p>Jobs are <em>updated</em> via a <code>PATCH</code> or <code>PUT</code> request to <code>/jobs/:id</code>. This is usually
used by facility services to update the job status and provide feedback.</p>
<p>The body of the request should follow the UpdateJobDto:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">"statusCode"</span>: <span class="hljs-string">"string"</span>,
  <span class="hljs-string">"statusMessage"</span>: <span class="hljs-string">"string"</span>,
  <span class="hljs-string">"jobResultObject"</span>: {}
}
</code></pre>
</li>
<li><p>Jobs may be <em>deleted</em> periodically during maintenance. This is usually not done by
users. Only members of groups listed in the <code>DELETE_JOB_GROUPS</code> env variable can
delete jobs.</p>
</li>
</ol>
<h3 id="referencing-datasets">Referencing datasets</h3>
<p>Many (but not all) jobs relate to datasets. These are specified during job creation in
the <code>jobParams.datasetList</code> array. The array should contain objects with a <code>pid</code> string
and a <code>files</code> array listing individual files that the job should be applied to. An empty
<code>files</code> array indicates that the job should apply to all files.</p>
<pre><code class="lang-json">{
  <span class="hljs-string">"type"</span>: ...,
  <span class="hljs-string">"jobParams"</span>: {
    <span class="hljs-string">"datasetList"</span>: [
      {
        <span class="hljs-string">"pid"</span>: <span class="hljs-string">"12.3456..."</span>,
        <span class="hljs-string">"files"</span>: []
      }
    ]
  }
}
</code></pre>
<h3 id="status-codes">Status Codes</h3>
<p>External systems can provide updates to the user by updating the job via the REST API.</p>
<ul>
<li><code>statusCode</code> is a machine readable status code. Values can be customized for different
job types, but are usually single-word strings in camel-case. Some example values are
given below.</li>
<li><code>statusMessage</code> is a human-readable description of the job state. This string is
displayed to the user.</li>
<li><code>jobResultObject</code> is a json object with additional machine-readable state information.</li>
</ul>
<p>Newly created jobs will have <code>"statusCode": "jobSubmitted"</code> and <code>"statusMessage": "Job
Submitted."</code>. These values can be customized using the <code>JOB_DEFAULT_STATUS_CODE</code> and
<code>JOB_DEFAULT_STATUS_MESSAGE</code> environmental variables.</p>
<p>Status codes can be used to implement state machine logic in an external system, such as
an archive infrastructure. The archive system can be notified about new and updated jobs
through <em>actions</em> (see below) which might call a URL or post to a message broker. The
archive system then sends a <code>PATCH</code> request to update the job, triggering further
actions. While status codes can be customized for each institute, the following statuses
are given as examples for archive and retrieve jobs:</p>
<table>
<thead>
<tr>
<th>statusCode</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>jobSubmitted</td>
<td>Freshly created job</td>
</tr>
<tr>
<td>inProgress</td>
<td>The archive system is working on the job</td>
</tr>
<tr>
<td>finishedSuccessful</td>
<td>Success!</td>
</tr>
<tr>
<td>finishedWithDatasetErrors</td>
<td>A user error occurred relating to one or more datasets; see <code>datasetlifecycle.archiveStatusMessage</code> of any related datasets for more information</td>
</tr>
<tr>
<td>finishedUnsuccessful</td>
<td>A system error occurred</td>
</tr>
</tbody>
</table>
<p>Additional status changes may be associated with datasets referenced in
<code>jobParams.datasetList</code>, for example in the <code>datasetlifecycle.archiveStatusMessage</code>
field.</p>
<p>It is recommended that values of <code>statusCode</code> be configured for each job type using a
<a href="#validate"><code>validate</code></a> action (see below).</p>
<h3 id="actions">Actions</h3>
<p>After <em>create</em> and <em>update</em> stages, a series of actions can be performed by SciCat. This
can be things like sending an email, posting a message to a message broker, or calling
an API. The <code>jobParams</code> and <code>jobResultObject</code> are used to provide additional information
that the actions may need, such as the list of datasets the job refers to.</p>
<p>A full list of built-in actions is given below. A plugin mechanism for registering new
actions is also planned for a future SciCat release.</p>
<h3 id="migration-notes">Migration Notes</h3>
<p>For general information about migrating from v3.x, see <a href="../../Migration.html">Migration</a>.</p>
<p>In v3.x the <code>archive</code>, <code>retrieve</code>, and <code>public</code> jobs were hard-coded. In v4.x the job
types can be arbitrary strings; however we recommend using the standard job names to
avoid confusion.</p>
<p>The data transfer objects for job endpoints have changed in v4.x. We recommend migrating
tools to use the new <code>/api/v4/jobs</code> endpoints. Old <code>/api/v3/Jobs</code> endpoints are still
available using the old models, but may have some restrictions.</p>
<!-- TODO: Add a table mapping the old schemas to the new ones -->
<p>Also note that some checks that were performed by default in v3.x for certain job types
must now be configured explicitly as actions. These are included in the provided
<code>jobConfig.recommended.yaml</code> file and are also noted below.</p>
<h2 id="configuration">Configuration</h2>
<p>In SciCat v3.x, a limited number of jobs were hard-coded into the code base. This was
changed in v4.x to allow each site to configure their own set of jobs and customize
actions based on the job status.</p>
<p>The available jobs are configured in the file <code>jobConfig.yaml</code> (or can be overridden
with the <code>JOB_CONFIGURATION_FILE</code> <a href="../configuration.html#environment-variables">environment
variable</a>). An example
<code>jobConfig.example.yaml</code> file is available
<a href="https://github.com/SciCatProject/scicat-backend-next/blob/master/jobConfig.example.yaml" target="_blank">here</a>.</p>
<h3 id="configuration-overview">Configuration overview</h3>
<p>The top-level configuration is structured like this:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">configVersion:</span> <span class="hljs-string">v1.0</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">jobType:</span> <span class="hljs-string">archive</span>
    <span class="hljs-attr">create:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">"#datasetOwner"</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">...</span>
    <span class="hljs-attr">update:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">archivemanager</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">...</span>
</code></pre>
<ul>
<li><code>configVersion</code> is a string that indicates the version of this configuration file. It
is not used by SciCat itself, but is useful for migrating jobs if the configuration
changes. SciCat will log a warning if a job was updated with a different config
version than it was created with.</li>
<li><code>jobs</code> is an array allowing the configuration of different job types</li>
<li><code>jobType</code> can be defined for each SciCat instance, but the names <code>archive</code>,
<code>retrieve</code>, and <code>public</code> are traditionally the most common jobs. Only jobs matching a
configured jobType will be accepted by the backend.</li>
<li><code>create</code> and <code>update</code> correspond to <code>POST</code> and <code>PATCH</code> requests to the <code>/jobs</code>
endpoint. These configure 'actions' which are run when at different phases of the job
lifecycle. The actions are defined in the <a href="#actions-configuration">job actions
section</a>.</li>
<li><code>auth</code> configures the roles authorized to use the endpoint for each job operation.</li>
<li><code>actions</code> give a list of actions to run when the endpoint is called.</li>
</ul>
<p>Production configuration files may contain duplicate actions. Using yaml
<a href="https://yaml.org/spec/1.2.2/#alias-nodes" target="_blank">aliases</a> is recommended to avoid unneccessary
duplication.</p>
<h3 id="authorization">Authorization</h3>
<p>Values for <code>auth</code> are described in <a href="../authorization/authorization_jobs.html">JobsAuthorization</a>.
Some authorization values may require certain information to be passed in the request body;
for instance, <code>"#datasetOwner"</code> requires that a dataset be passed.</p>
<blockquote>
<p><strong>Caution</strong> Setting <code>auth</code> to a permissive value (eg <code>#all</code>) could expose archiving
services to external users. Please consider the security model carefully when
configuring jobs.</p>
</blockquote>
<h3 id="templates">Templates</h3>
<p>Many actions can be configured using templates, which get filled when the action runs.
Template strings use <a href="https://handlebarsjs.com/" target="_blank">Handlebars</a> syntax. The following
top-level variables are availabe in the handlebars context:</p>
<table>
<thead>
<tr>
<th>Top-level variable</th>
<th>Type</th>
<th>Examples</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>request</code></td>
<td><code>CreateJobDto</code> or<br></br><code>UpdateJobDto</code></td>
<td><code>{{{request.type}}}</code><br></br><code>{{{request.jobParams}}}</code></td>
<td>HTTP Request body</td>
</tr>
<tr>
<td><code>job</code></td>
<td><code>JobClass</code></td>
<td><code>{{{job.id}}}</code></td>
<td>The job. During the validate phase this is the previous job values (if any); during the perform phase it will be the current database value.</td>
</tr>
<tr>
<td><code>datasets</code></td>
<td><code>DatasetClass[]</code></td>
<td><code>{{#each datasets}}{{{pid}}}{{/each}}</code></td>
<td>Array of all datasets referenced in <code>job.jobParams.datasetList</code>.</td>
</tr>
<tr>
<td><code>env</code></td>
<td><code>object</code></td>
<td><code>{{{env.SECRET_TOKEN}}}</code></td>
<td>Access environmental variables</td>
</tr>
</tbody>
</table>
<p>Environmental variables are particularly useful for secrets that should not be stored in
the config file.</p>
<p>Most variables should use handlebars "triple-stash" (<code>{{{ var }}}</code>) to disable html
escaping. Use double-brackets (<code>{{ var }}</code>) for HTML email bodies where special
characters should be escaped. Templates that expect JSON should use <code>{{{ jsonify var
}}}</code> to ensure correct quoting. In addition to the built-in handlebars functions, the
following additional helpers are defined:</p>
<ul>
<li><code>unwrapJSON</code>: convert a json object to HTML (arrays become <code>&lt;ul&gt;</code>, objects are formatted as key:value lines, etc)</li>
<li><code>keyToWord</code>: convert camelCase to space-separated words</li>
<li><code>eq</code>: test exact equality (<code>===</code>)</li>
<li><code>jsonify</code>: Convert an object to JSON</li>
<li><code>job_v3</code>: Convert a JobClass object to the old JobClassV3</li>
<li><code>urlencode</code>: urlencode input</li>
<li><code>base64enc</code>: base64enc input</li>
</ul>
<p>Not all variables may be available at all times. Actions run either before job is saved
to the database (<code>validate</code> phase) or after (<code>perform</code> phase). The following table
indicates what values can be expected in the context during each phase.</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Phase</th>
<th>request</th>
<th>job</th>
<th>datasets</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>validate</td>
<td><code>CreateJobDto</code></td>
<td><em>undefined</em></td>
<td><code>DatasetClass[]</code></td>
</tr>
<tr>
<td>create</td>
<td>perform</td>
<td><code>CreateJobDto</code></td>
<td><code>JobClass</code></td>
<td><code>DatasetClass[]</code></td>
</tr>
<tr>
<td>update</td>
<td>validate</td>
<td><code>UpdateJobDto</code></td>
<td><code>JobClass</code> (previous values)</td>
<td><code>DatasetClass[]</code></td>
</tr>
<tr>
<td>update</td>
<td>perform</td>
<td><code>UpdateJobDto</code></td>
<td><code>JobClass</code> (updated values)</td>
<td><code>DatasetClass[]</code></td>
</tr>
</tbody>
</table>
<h3 id="actions-configuration">Actions Configuration</h3>
<p>The following actions are built-in to SciCat and can be included in the <code>actions</code> array.</p>
<h4 id="urlaction">URLAction</h4>
<p>The <code>URL</code> action responds to a Job event by making an HTTP call.</p>
<p><strong>Configuration</strong>:
The <em>URL action</em>, per job stage (<em>create</em>, <em>update</em>) if defined, must be configured in
<code>jobConfig.yaml</code>. It supports templating, by extracting the values from the job schema.</p>
<p>For example:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">url</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:3000/api/v3/health?jobid={{{request.id}}}</span>
  <span class="hljs-attr">method:</span> <span class="hljs-string">GET</span>
  <span class="hljs-attr">headers:</span>
    <span class="hljs-attr">accept:</span> <span class="hljs-string">application/json</span>
    <span class="hljs-attr">Authorization:</span> <span class="hljs-string">"Bearer <span class="hljs-template-variable">{{{env.ARCHIVER_AUTH_TOKEN}}</span>}"</span><span class="hljs-string">,</span>
  <span class="hljs-attr">body:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{{jsonify job}}</span>}
</span></code></pre>
<p>Where:</p>
<ul>
<li><code>url</code> (required): The URL for the request.This can include template variables.</li>
<li><code>method</code> (optional): The HTTP method for the request, e.g. "GET", "POST".</li>
<li><code>headers</code> (optional): An object containing HTTP headers to be included in the request.</li>
<li><code>body</code> (optional): The body of the request, for methods like "POST" or "PUT".</li>
</ul>
<p>It is recommended that authorization tokens be stored as environmental variables rather
than included directly in the jobConfig.yaml file.</p>
<h4 id="validate">Validate</h4>
<p>The <code>validate</code> action is used to validate requests to the job endpoints. It is used to
enforce custom constraints on <code>jobParams</code> or <code>jobResultObject</code> for each job type. If
other actions rely on custom fields in their templates they should first be validated
with this action.</p>
<p>ValidateAction is configured with a series of <code>&lt;path&gt;: &lt;typecheck&gt;</code> pairs which describe
a constraint to be validated. These can be applied to different contexts:</p>
<ul>
<li><strong><code>request</code></strong> - Checks the incoming request body (aka the DTO).</li>
<li><strong><code>datasets</code></strong> - requires that a list of datasets be included in
<code>jobParams.datasetList</code>. Checks are applied to each dataset.</li>
</ul>
<p>Validation occurs before the job gets created in the database, while most other actions
are performed after the job is created. This means that correctly configuring validation
is important to detect user errors early.</p>
<p>Configuration is described in detail below. However, a few illustrative examples are
provided first.</p>
<p><strong>Configuration</strong>:
The config file for a validate action will look like this:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">validate</span>
  <span class="hljs-attr">request:</span>
    <span class="hljs-string">&lt;path&gt;:</span> <span class="hljs-string">&lt;typecheck&gt;</span>
  <span class="hljs-attr">datasets:</span>
    <span class="hljs-string">&lt;path&gt;:</span> <span class="hljs-string">&lt;typecheck&gt;</span>
</code></pre>
<p>Usually <code>&lt;path&gt;</code> will be a dot-delimited field in the DTO, eg. "jobParams.name".
Technically it is a <a href="https://github.com/JSONPath-Plus/JSONPath" target="_blank">JSONPath-Plus</a>
expression, which is applied to the request body or dataset to extract any matching
items. When writing a jobconfig file it may be helpful to test an expected request body
against the <a href="https://jsonpath-plus.github.io/JSONPath/demo/" target="_blank">JSONPath demo</a>.</p>
<p>The <code>&lt;typecheck&gt;</code> expression is a JSON Schema. While complicated schemas are possible,
the combination with JSONPath makes common type checks very concise and legible.
Here are some example <code>&lt;typecheck&gt;</code> expressions:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">validate</span>
  <span class="hljs-attr">request:</span> <span class="hljs-comment"># applies to the request body</span>
    <span class="hljs-attr">jobParams.stringVal:</span> <span class="hljs-comment"># match simple types</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
    <span class="hljs-attr">jobParams.enumVal:</span> <span class="hljs-comment"># literal values</span>
      <span class="hljs-attr">enum:</span> [<span class="hljs-string">"yes"</span>, <span class="hljs-string">"no"</span>]
    <span class="hljs-attr">jobResultObject.mustBeTrue:</span> <span class="hljs-comment"># enforce a value</span>
      <span class="hljs-attr">const:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">"jobParams":</span> <span class="hljs-comment"># Apply external JSON Schema to all params</span>
      <span class="hljs-string">$ref:</span> <span class="hljs-string">https://json.schemastore.org/schema-org-thing.json</span>
  <span class="hljs-attr">dataset:</span> <span class="hljs-comment"># applies to all datasets</span>
    <span class="hljs-attr">datasetLifecycle.archivable:</span>
      <span class="hljs-attr">const:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>Validation will result in a <code>400 Bad Request</code> response if either the path is not found
or if any values matching the path do not validate against the provided schema.</p>
<h5 id="example-1-require-extra-template-data">Example 1: Require extra template data</h5>
<p>Consider a case where you want to pass a value from the request body through to other
actions. For example, you want to allow the requestor to specify the subject of an email
to be sent in the request body like this:</p>
<pre><code class="lang-json"><span class="hljs-variable constant_">POST</span> /jobs
{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"email_demo"</span>,
  <span class="hljs-string">"jobParams"</span>: {
    <span class="hljs-string">"subject"</span>: <span class="hljs-string">"Thanks for using scicat!"</span>
  }
}
</code></pre>
<p>In this case an <a href="#email"><code>email</code> action</a> would be configured using handlebars to insert the
<code>jobParams.subject</code> value. However, a <code>validate</code> action should also be configured to
catch errors early where the subject is not specified:</p>
<p><code>jobConfig.yaml</code>:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">jobType:</span> <span class="hljs-string">email_demo</span>
    <span class="hljs-attr">create:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">admin</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">validate</span>
          <span class="hljs-attr">request:</span>
            <span class="hljs-attr">jobParams.subject:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">email</span>
          <span class="hljs-attr">to:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{{job.contactEmail}}</span>}"</span>
          <span class="hljs-attr">subject:</span> <span class="hljs-string">"[SciCat] <span class="hljs-template-variable">{{{job.jobParams.subject}}</span>}"</span>
          <span class="hljs-attr">bodyTemplate:</span> <span class="hljs-string">demo_email.html</span>
    <span class="hljs-attr">update:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">admin</span>
      <span class="hljs-attr">actions:</span> []
</code></pre>
<h5 id="example-2-enforce-datasetlifecycle-state">Example 2: Enforce datasetLifecycle state</h5>
<p>Many job types require a dataset to be included. These are specified in
<code>jobParams.datasetList</code> like this:</p>
<pre><code class="lang-json"><span class="hljs-variable constant_">POST</span> /jobs
{
  <span class="hljs-string">"owner"</span>...
  <span class="hljs-string">"jobParams"</span>: {
    <span class="hljs-string">"datasetList"</span>: [
      {
        <span class="hljs-string">"pid"</span>: <span class="hljs-string">"examplePID"</span>,
        <span class="hljs-string">"files"</span>: []
      }
    ]
  }
}
</code></pre>
<p>Permission to access to the datasets is checked with the <code>#dataset*</code> authentication
methods, but other properties need to be enforced with a <code>validate</code> action.</p>
<p>The following validate actions are recommended for <code>archive</code>, <code>retrieve</code> and <code>publish</code>
jobs:</p>
<p><code>jobConfig.yaml</code>:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">jobType:</span> <span class="hljs-string">archive</span>
    <span class="hljs-attr">create:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">"#datasetOwner"</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">validate</span>
          <span class="hljs-attr">datasets:</span>
            <span class="hljs-attr">datasetlifecycle.archivable:</span>
              <span class="hljs-attr">const:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">update:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">archivemanager</span>
      <span class="hljs-attr">actions:</span> []
  <span class="hljs-bullet">-</span> <span class="hljs-attr">jobType:</span> <span class="hljs-string">retrieve</span>
    <span class="hljs-attr">create:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">"#datasetOwner"</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">validate</span>
          <span class="hljs-attr">datasets:</span>
            <span class="hljs-attr">datasetlifecycle.retrievable:</span>
              <span class="hljs-attr">const:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">update:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">archivemanager</span>
      <span class="hljs-attr">actions:</span> []
  <span class="hljs-bullet">-</span> <span class="hljs-attr">jobType:</span> <span class="hljs-string">public</span>
    <span class="hljs-attr">create:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">"#all"</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">validate</span>
          <span class="hljs-attr">datasets:</span>
            <span class="hljs-attr">isPublished:</span>
              <span class="hljs-attr">const:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">update:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">archivemanager</span>
</code></pre>
<h5 id="example-3-define-statuscodes">Example 3: Define statusCodes</h5>
<p>This example restricts the permitted statusCodes to a fixed list. This can help detect
typos and ill-defined states.</p>
<pre><code>jobs:
  - jobType: archive
    create:
      auth: "#datasetOwner"
      actions: ...
    update:
      auth: archivemanager
      actions:
        - actionType: validate
          requests:
            statusCode:
              enum:
                - jobSubmitted
                - inProgress
                - finishedSuccessful
                - finishedWithDatasetErrors
                - finishedUnsuccessful
</code></pre><h4 id="email">Email</h4>
<p>The <code>email</code> action responds to a Job event by sending an email.</p>
<p><strong>Configuration</strong>:
The <em>Mail service</em> must first be configured through environmental variables, as described in the <a href="../configuration.html">configuration</a>.
There you can define the <code>EMAIL_TYPE</code>, which can be either <code>smtp</code> or <code>ms365</code>, along with the type's respective configuration values.
While SMTP is the default, MS365 adds support for <a href="https://learn.microsoft.com/en-us/graph/api/resources/mail-api-overview?view=graph-rest-1.0" target="_blank">Microsoft Graph API</a> for sending emails.
This is an alternative to SMTP for MS365 accounts that would otherwise require interactive OAuth logins, making it useful for automated emails.
To use MS365, you (or your azure admin) will need to generate a <code>tenantId</code>, <code>clientId</code>, and <code>clientSecret</code> with permissions to send email.
The process is described <a href="https://docs.emailengine.app/setting-up-oauth2-with-outlook/" target="_blank">here</a>.
Upon instantiation, the service will create the configured transporter, ready to sent emails upon request.</p>
<p>The <em>Email action</em>, per job stage (<em>create</em>, <em>update</em>) if defined, must be configured in <code>jobConfig.yaml</code>.
It supports templating, by extracting the values from the job schema.</p>
<p>Example:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">email</span>
  <span class="hljs-attr">to:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{{job.contactEmail}}</span>}"</span>
  <span class="hljs-attr">from:</span> <span class="hljs-string">"sender@example.com"</span><span class="hljs-string">,</span>
  <span class="hljs-attr">subject:</span> <span class="hljs-string">"[SciCat] Your <span class="hljs-template-variable">{{{job.type}}</span>} job was submitted successfully."</span>
  <span class="hljs-attr">bodyTemplateFile:</span> <span class="hljs-string">"path/to/job-template-file.html"</span>
</code></pre>
<p>Where:</p>
<ul>
<li><code>to</code>: The recipient's email address. This can include template variables.</li>
<li><code>from</code>: The sender's email address. If no value is provided, then the default sender email address will be used, as defined in <a href="../configuration.html">configuration</a>.</li>
<li><code>subject</code>: The subject of the email. This can include template variables.</li>
<li><code>bodyTemplateFile</code>: The path to the HTML template file for the email body.</li>
</ul>
<p>You can create your own template for the email's body, which should be a valid html file - for example:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span>
  ...
  <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
      Your {{{job.type}}} job with id {{{job.id}}} has been submitted ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 id="rabbitmq">RabbitMQ</h4>
<p>The <code>RabbitMQ</code> action implements a way for the backend to connect to a Message Broker.
It publishes the new or updated Job entry to a messaging queue, from where it can be picked up by any program willing to react to this Job.</p>
<p><strong>Configuration</strong>:
The <em>RabbitMQ service</em> must first be configured through environmental variables, as described in the <a href="../configuration.html">configuration</a>.
Upon instantiation, it will create a RabbitMQ connection and channel.</p>
<p>The <em>RabbitMQ action</em>, per job stage (<em>create</em>, <em>update</em>) if defined, must be configured in <code>jobConfig.yaml</code>, for example:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">rabbitmq</span>
  <span class="hljs-attr">exchange:</span> <span class="hljs-string">jobs.write</span>
  <span class="hljs-attr">key:</span> <span class="hljs-string">jobqueue</span>
  <span class="hljs-attr">queue:</span> <span class="hljs-string">client.jobs.write</span>
</code></pre>
<p>Where:</p>
<ul>
<li>An <code>exchange</code> is a routing mechanism that receives messages and routes them to the appropriate queues.</li>
<li>A routing <code>key</code> is a string used to label messages, to specify the message's purpose or destination.</li>
<li>A <code>queue</code> is a storage buffer where messages are held until they are consumed.</li>
</ul>
<p>If needed, different queues can be defined for different purposes.
Exchanges and keys can be reused for different queues.</p>
<p>Trying to configure a RabbitMQ action, when the service is not enabled, will throw an error that will prevent the application from running.</p>
<h4 id="switch">Switch</h4>
<p>Switch which actions are performed based on a condition, similar to a 'switch' or 'case'
statement. It is added to the 'actions' list of a job, and itself contains a list of
sub-actions that will be performed conditionally.</p>
<p><strong>Configuration</strong>:
The action is added to the <code>actions</code> section of a job in <code>jobConfig.yaml</code> as follows:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">switch</span>
  <span class="hljs-attr">phase:</span> <span class="hljs-string">validate</span> <span class="hljs-string">|</span> <span class="hljs-string">perform</span> <span class="hljs-string">|</span> <span class="hljs-string">all</span>
  <span class="hljs-attr">property:</span> <span class="hljs-string">some.property</span>
  <span class="hljs-attr">cases:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">exact</span> <span class="hljs-string">value</span> <span class="hljs-string">match</span>
    <span class="hljs-attr">actions:</span> [<span class="hljs-string">...</span>]
  <span class="hljs-bullet">-</span> <span class="hljs-attr">regex:</span> <span class="hljs-string">/^regex$/i</span>
    <span class="hljs-attr">actions:</span> [<span class="hljs-string">...</span>]
  <span class="hljs-bullet">-</span> <span class="hljs-attr">schema:</span> {<span class="hljs-string">JSON</span> <span class="hljs-string">schema</span>}
    <span class="hljs-attr">actions:</span> [<span class="hljs-string">...</span>]
  <span class="hljs-bullet">-</span> <span class="hljs-comment"># default</span>
    <span class="hljs-attr">actions:</span> [<span class="hljs-string">...</span>]
</code></pre>
<ul>
<li><code>property</code> (required) Name of a variable to test against. This is specified as a
JSONPath+ spec; the most common case is a simple dot-delimited list of keys.
Properties are selected from the same context used for templates; see
<a href="#templates">templates</a> above for a description of the values available</li>
<li><code>phase</code> (required) Determines which phases the switch statement runs. Some properties
may be unavailable in some phases (see <a href="#templates">templates</a>), requiring limiting
when the switch statement is evaluated. Actions listed within the <code>cases</code> section will
also be run only in the phase listed here.<ul>
<li><code>validate</code>: Evaluated before the request is accepted and written to the database;
useful for <code>validate</code> actions.</li>
<li><code>perform</code>: Evaluated after the request is written to the database; most actions
run in this phase.</li>
<li><code>all</code>: Evaluate the switch condition in both phases</li>
</ul>
</li>
<li><code>cases</code>: one or more conditions to match the property against. Conditions are tested in
order. No "fall through" behavior is implemented; this can be approximated using yaml
anchors and aliases if needed. The following types of conditions are available:<ul>
<li><code>match</code>: match the property against a string or literal value. This use javascript
<code>==</code> for equality; use a JSON schema with a <code>const</code> term if deep equality is needed.</li>
<li><code>regex</code>: Match a string property against a regular expression. Delimiting slashes
are required. The regex is matched using javascript <code>RegExp.test</code>. Flags are
supported.</li>
<li><code>schema</code>: Match the property against a JSON schema.</li>
<li>If no condition is included then the case will always match. This is useful for
adding a terminal 'default' condition (eg with an <code>error</code> action).</li>
</ul>
</li>
</ul>
<p>Some JSON paths may return multiple values. For instance, accessing dataset properties
should use array paths such as <code>datasets[*].storageLocation</code>. If multiple unique values
are returned then the request will return a 400 error. If the property doesn't match
any values then a value of <code>undefined</code> will be used, which can be handled by a default
case.</p>
<p><strong>Examples</strong>:</p>
<p>Switch can be used as a simple 'if' statement. For instance, it could be used to respond
to different statusCodes (this case could also be handled with handlebars templates):</p>
<pre><code class="lang-yaml">  <span class="hljs-bullet">-</span> <span class="hljs-attr">jobType:</span> <span class="hljs-string">retrieve</span>
    <span class="hljs-attr">create:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">'#datasetAccess'</span>
    <span class="hljs-attr">update:</span>
      <span class="hljs-attr">auth:</span> <span class="hljs-string">archiveManager</span>
      <span class="hljs-attr">actions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">switch</span>
          <span class="hljs-attr">phase:</span> <span class="hljs-string">perform</span>
          <span class="hljs-attr">property:</span> <span class="hljs-string">job.statusCode</span>
          <span class="hljs-attr">cases:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">finishedSuccessful</span>
              <span class="hljs-attr">actions:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">email</span>
                <span class="hljs-attr">to:</span> {{{<span class="hljs-string">job.contactEmail</span>}}}
                <span class="hljs-attr">subject:</span> <span class="hljs-string">"[SciCat] Your <span class="hljs-template-variable">{{{job.type}}</span>} job was successful!"</span>
                <span class="hljs-attr">bodyTemplateFile:</span> <span class="hljs-string">retrieve-success.html</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">actions:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">email</span>
                <span class="hljs-attr">to:</span> {{{<span class="hljs-string">job.contactEmail</span>}}}
                <span class="hljs-attr">subject:</span> <span class="hljs-string">"[SciCat] Your <span class="hljs-template-variable">{{{job.type}}</span>} job has state <span class="hljs-template-variable">{{{job.statusCode}}</span>}"</span>
                <span class="hljs-attr">bodyTemplateFile:</span> <span class="hljs-string">retrieve-failure.html</span>
</code></pre>
<h4 id="error">Error</h4>
<p>Throw a custom HTTP error. This can be useful for testing or in combination with a
<code>switch</code> action to detect error conditions. The error is thrown before making any
database changes.</p>
<p><strong>Configuration</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">error</span>
  <span class="hljs-attr">message:</span> <span class="hljs-string">An</span> <span class="hljs-string">error</span> <span class="hljs-string">has</span> <span class="hljs-string">occurred!</span>
  <span class="hljs-attr">status:</span> <span class="hljs-number">418</span>
</code></pre>
<ul>
<li><code>message</code>: Error message. The response will include this message in the JSON body.
The message can contain handlebars template variables, which are passed the incoming
request body as a context.</li>
<li><code>status</code> (optional): HTTP error code</li>
</ul>
<h4 id="log">Log</h4>
<p>This is a dummy action, useful for debugging. It adds a log entry when executed.
Usually the entry is added after the job request has been processed (<code>perform</code>),
but it can also be configured to log messages during initialization or when validating
an incoming job.</p>
<p><strong>Configuration</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">actionType:</span> <span class="hljs-string">log</span>
  <span class="hljs-attr">init:</span> <span class="hljs-string">"Job initialized with params <span class="hljs-template-variable">{{{ jsonify this }}</span>}"</span>
  <span class="hljs-attr">validate:</span> <span class="hljs-string">"Request body received: <span class="hljs-template-variable">{{{ jsonify this }}</span>}"</span>
  <span class="hljs-attr">perform:</span> <span class="hljs-string">"Job saved: <span class="hljs-template-variable">{{{ jsonify this }}</span>}"</span>
</code></pre>
<p>All arguments are optional.</p>
<ul>
<li><code>init</code> (optional): Log message to print during startup. The actions's configuration
section from jobConfig.yaml is available as a Handlebars context. Default: ""</li>
<li><code>validate</code> (optional): Log message to print when the job request is received. The
request body (aka DTO) is available as a Handlebars context. Default: ""</li>
<li><code>perform</code> (optional): Log message to print after the job is saved to the database.
The updated job object is available as a Handlebars context.
Default: <code>"Performing job for {{{job.type}}}"</code></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../configuration.html" class="navigation navigation-prev " aria-label="Previous page: Backend">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../authorization.html" class="navigation navigation-next " aria-label="Next page: Authorization">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Jobs","level":"1.5.2.7.1.1","depth":5,"next":{"title":"Authorization","level":"1.5.2.7.2","depth":4,"path":"Development/v4.x/backend/authorization.md","ref":"Development/v4.x/backend/authorization.md","articles":[{"title":"Datasets","level":"1.5.2.7.2.1","depth":5,"path":"Development/v4.x/backend/authorization/authorization_datasets.md","ref":"Development/v4.x/backend/authorization/authorization_datasets.md","articles":[]},{"title":"OrigDatablocks","level":"1.5.2.7.2.2","depth":5,"path":"Development/v4.x/backend/authorization/authorization_origdatablocks.md","ref":"Development/v4.x/backend/authorization/authorization_origdatablocks.md","articles":[]},{"title":"Proposals","level":"1.5.2.7.2.3","depth":5,"path":"Development/v4.x/backend/authorization/authorization_proposals.md","ref":"Development/v4.x/backend/authorization/authorization_proposals.md","articles":[]},{"title":"Jobs","level":"1.5.2.7.2.4","depth":5,"path":"Development/v4.x/backend/authorization/authorization_jobs.md","ref":"Development/v4.x/backend/authorization/authorization_jobs.md","articles":[]},{"title":"Instruments","level":"1.5.2.7.2.5","depth":5,"path":"Development/v4.x/backend/authorization/authorization_instruments.md","ref":"Development/v4.x/backend/authorization/authorization_instruments.md","articles":[]},{"title":"Users","level":"1.5.2.7.2.6","depth":5,"path":"Development/v4.x/backend/authorization/authorization_users.md","ref":"Development/v4.x/backend/authorization/authorization_users.md","articles":[]},{"title":"Samples","level":"1.5.2.7.2.7","depth":5,"path":"Development/v4.x/backend/authorization/authorization_samples.md","ref":"Development/v4.x/backend/authorization/authorization_samples.md","articles":[]}]},"previous":{"title":"Backend","level":"1.5.2.7.1","depth":4,"path":"Development/v4.x/backend/configuration.md","ref":"Development/v4.x/backend/configuration.md","articles":[{"title":"Jobs","level":"1.5.2.7.1.1","depth":5,"path":"Development/v4.x/backend/configuration/jobconfig.md","ref":"Development/v4.x/backend/configuration/jobconfig.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["chapter-fold","mermaid-gb3"],"styles":{"website":"styles/website.css"},"pluginsConfig":{"chapter-fold":{},"mermaid-gb3":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"SciCat Documentation","gitbook":"*"},"file":{"path":"Development/v4.x/backend/configuration/jobconfig.md","mtime":"2025-09-05T10:50:19.289Z","type":"markdown"},"gitbook":{"version":"5.1.4","time":"2025-09-05T10:50:24.603Z"},"basePath":"../../../..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../../../gitbook/gitbook.js"></script>
    <script src="../../../../gitbook/theme.js"></script>
    
        
        <script src="../../../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="../../../../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

