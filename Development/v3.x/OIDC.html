
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>OIDC Integration Â· SciCat Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.7.5">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Ngrx.html" />
    
    
    <link rel="prev" href="Login.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    SciCat Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../Users/">
            
                <a href="../../Users/">
            
                    
                    User Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../Users/Anonymous.html">
            
                <a href="../../Users/Anonymous.html">
            
                    
                    Anonymous View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../Users/Login.html">
            
                <a href="../../Users/Login.html">
            
                    
                    Login
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../Users/Dashboard.html">
            
                <a href="../../Users/Dashboard.html">
            
                    
                    Dashboard
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../Users/Dataset_Details.html">
            
                <a href="../../Users/Dataset_Details.html">
            
                    
                    Dataset Details
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../../Users/Dataset_Details_Files.html">
            
                <a href="../../Users/Dataset_Details_Files.html">
            
                    
                    Dataset Filelisting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../../Users/Dataset_Attachments.html">
            
                <a href="../../Users/Dataset_Attachments.html">
            
                    
                    Dataset Attachments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.3" data-path="../../Users/View_Raw_Metadata.html">
            
                <a href="../../Users/View_Raw_Metadata.html">
            
                    
                    View Raw JSON data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.4" data-path="../../Users/Edit_Scientific_Metadata.html">
            
                <a href="../../Users/Edit_Scientific_Metadata.html">
            
                    
                    Edit Scientific Metadata
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../../Users/Publishing.html">
            
                <a href="../../Users/Publishing.html">
            
                    
                    Dataset Publishing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../../Users/Jobs.html">
            
                <a href="../../Users/Jobs.html">
            
                    
                    Archival and Retrieval Jobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../../Users/SampleData.html">
            
                <a href="../../Users/SampleData.html">
            
                    
                    Sample Data Entry
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../Operator/">
            
                <a href="../../Operator/">
            
                    
                    Operator Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../Operator/Step_by_Step_Setup.html">
            
                <a href="../../Operator/Step_by_Step_Setup.html">
            
                    
                    Step by Step instruction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../Operator/Step_by_Step_Setup_Docker.html">
            
                <a href="../../Operator/Step_by_Step_Setup_Docker.html">
            
                    
                    Deploy with Docker Compose
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../../Operator/Step_by_Step_Setup_Kubernetes.html">
            
                <a href="../../Operator/Step_by_Step_Setup_Kubernetes.html">
            
                    
                    Deploy with Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../../Operator/Step_by_Step_Setup_Zip_Service.html">
            
                <a href="../../Operator/Step_by_Step_Setup_Zip_Service.html">
            
                    
                    Deploy Zip Service
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../Ingestor/">
            
                <a href="../../Ingestor/">
            
                    
                    Ingestor Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../Ingestor/ingestManual.html">
            
                <a href="../../Ingestor/ingestManual.html">
            
                    
                    Ingest Manual PSI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../Ingestor/IngestManual_ESS.html">
            
                <a href="../../Ingestor/IngestManual_ESS.html">
            
                    
                    Ingest Instructions ESS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../../Ingestor/GettingMetadataIntoScicat.html">
            
                <a href="../../Ingestor/GettingMetadataIntoScicat.html">
            
                    
                    Manual Ingest the Hard Way
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../">
            
                <a href="../">
            
                    
                    Developers Guide
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="./">
            
                <a href="./">
            
                    
                    v3.x
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="StartHere.html">
            
                <a href="StartHere.html">
            
                    
                    Overview of Backend and Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="Data_Model.html">
            
                <a href="Data_Model.html">
            
                    
                    An Introduction to the Data Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="Running.html">
            
                <a href="Running.html">
            
                    
                    Running the Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.4" data-path="Configuration.html">
            
                <a href="Configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.5" data-path="Theming.html">
            
                <a href="Theming.html">
            
                    
                    Theming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.6" data-path="Login.html">
            
                <a href="Login.html">
            
                    
                    Login and Accounts
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.1.7" data-path="OIDC.html">
            
                <a href="OIDC.html">
            
                    
                    OIDC Integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.8" data-path="Ngrx.html">
            
                <a href="Ngrx.html">
            
                    
                    State Management in Angular
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.9" data-path="Testing_backend.html">
            
                <a href="Testing_backend.html">
            
                    
                    Testing Backend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.10" data-path="Testing.html">
            
                <a href="Testing.html">
            
                    
                    Testing Frontend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.11" data-path="Contributing.html">
            
                <a href="Contributing.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.12" data-path="Development_Methods.html">
            
                <a href="Development_Methods.html">
            
                    
                    Git Flow Workflow
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../v4.x/README.md">
            
                <span>
            
                    
                    v4.x
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="../v4.x/overview.html">
            
                <a href="../v4.x/overview.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="../v4.x/Data_Model.html">
            
                <a href="../v4.x/Data_Model.html">
            
                    
                    An Introduction to the Data Model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="../v4.x/running.html">
            
                <a href="../v4.x/running.html">
            
                    
                    Running the Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4" data-path="../v4.x/configuration.html">
            
                <a href="../v4.x/configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.4.1" data-path="../v4.x/backend/configuration.html">
            
                <a href="../v4.x/backend/configuration.html">
            
                    
                    Backend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4.2" data-path="../v4.x/backend/authorization.html">
            
                <a href="../v4.x/backend/authorization.html">
            
                    
                    Authorization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.4.2.1" data-path="../v4.x/backend/authorization/authorization_datasets.html">
            
                <a href="../v4.x/backend/authorization/authorization_datasets.html">
            
                    
                    Datasets
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4.2.2" data-path="../v4.x/backend/authorization/authorization_origdatablocks.html">
            
                <a href="../v4.x/backend/authorization/authorization_origdatablocks.html">
            
                    
                    OrigDatablocks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.4.2.3" data-path="../v4.x/backend/authorization/authorization_users.html">
            
                <a href="../v4.x/backend/authorization/authorization_users.html">
            
                    
                    Users
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.4.3" data-path="../v4.x/frontend/configuration.html">
            
                <a href="../v4.x/frontend/configuration.html">
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.5" data-path="../v4.x/Theming.md">
            
                <span>
            
                    
                    Theming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.6" data-path="../v4.x/Login.html">
            
                <a href="../v4.x/Login.html">
            
                    
                    Login and Accounts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.7" data-path="../v4.x/OIDC.md">
            
                <span>
            
                    
                    OIDC Integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.8" data-path="../v4.x/testing.md">
            
                <span>
            
                    
                    Testing
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.8.1" data-path="../v4.x/backend/testing_backend.html">
            
                <a href="../v4.x/backend/testing_backend.html">
            
                    
                    Backend
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.8.1.1" data-path="../v4.x/backend/testing/instrument.html">
            
                <a href="../v4.x/backend/testing/instrument.html">
            
                    
                    Instrument
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.8.1.2" data-path="../v4.x/backend/testing/user_authorization.html">
            
                <a href="../v4.x/backend/testing/user_authorization.html">
            
                    
                    User Authorization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.8.2" data-path="../v4.x/frontend/testing.md">
            
                <span>
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2.9" data-path="../v4.x/Migration.html">
            
                <a href="../v4.x/Migration.html">
            
                    
                    Migration v3.x to v4.x
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../Documentation.html">
            
                <a href="../Documentation.html">
            
                    
                    Documentation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <a target="_blank" href="https://scicatproject.github.io/api/">
            
                    
                    API Documentation
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >OIDC Integration</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="oidc-integration">OIDC Integration</h1>
<p>SciCat can integrate with one or more OIDC servers to provide Authentication. Integration requires configuration of both backend and frontend in order to setup the redirecting and handshaking that the OAuth2 code flow requires. Additionally, it may involve writing <a href="#backend-code-hooks">custom code hooks</a>  in the backend in order to properly handle profile information obtained by the OIDC Auth Provider.</p>
<h2 id="backend-configuration">Backend Configuration</h2>
<p>Configuration of the backend for OIDC involves adding a provider to <code>providers.json</code> file. See <a href="StartHere.html">Start Here</a> for more information on configuring this file.</p>
<p>Here is an example of a provider that uses Google as an authenticator. Google is used here because it is well-documented and commonly available.</p>
<pre><code class="lang-json">    <span class="hljs-string">&quot;google&quot;</span>: {
        <span class="hljs-string">&quot;provider&quot;</span>: <span class="hljs-string">&quot;oidc&quot;</span>,
        <span class="hljs-string">&quot;authScheme&quot;</span>: <span class="hljs-string">&quot;openid connect&quot;</span>,
        <span class="hljs-string">&quot;module&quot;</span>: <span class="hljs-string">&quot;passport-openidconnect&quot;</span>,
        <span class="hljs-string">&quot;authPath&quot;</span>: <span class="hljs-string">&quot;/auth/google&quot;</span>,
        <span class="hljs-string">&quot;successRedirect&quot;</span>: <span class="hljs-string">&quot;http://localhost/user&quot;</span>,
        <span class="hljs-string">&quot;failureRedirect&quot;</span>: <span class="hljs-string">&quot;http://localhost/login&quot;</span>,
        <span class="hljs-string">&quot;failureFlash&quot;</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">&quot;session&quot;</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">&quot;issuer&quot;</span>: <span class="hljs-string">&quot;https://accounts.google.com&quot;</span>,
        <span class="hljs-string">&quot;authorizationURL&quot;</span>: <span class="hljs-string">&quot;https://accounts.google.com/o/oauth2/v2/auth&quot;</span>,
        <span class="hljs-string">&quot;tokenURL&quot;</span>: <span class="hljs-string">&quot;https://oauth2.googleapis.com/token&quot;</span>,
        <span class="hljs-string">&quot;userInfoURL&quot;</span>: <span class="hljs-string">&quot;https://openidconnect.googleapis.com/v1/userinfo&quot;</span>,
        <span class="hljs-string">&quot;clientID&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>,
        <span class="hljs-string">&quot;clientSecret&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>,
        <span class="hljs-string">&quot;callbackURL&quot;</span>: <span class="hljs-string">&quot;http://localhost:3000/auth/google/callback&quot;</span>,
        <span class="hljs-string">&quot;scope&quot;</span>: [<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-string">&quot;profile&quot;</span>, <span class="hljs-string">&quot;openid&quot;</span>],
        <span class="hljs-string">&quot;loginCallback&quot;</span>: <span class="hljs-string">&quot;sampleLoginCallback&quot;</span>
    }
</code></pre>
<blockquote>
<p>Note that information about Google sign in can be found <a href="https://developers.google.com/identity/protocols/oauth2/openid-connect" target="_blank">here</a>, details are beyond the scope of this document.</p>
<p>Note that OIDC authentication services publish their specific settings in a Discovery document.. To find the settings for, say, google, see <a href="https://accounts.google.com/.well-known/openid-configuration" target="_blank">https://accounts.google.com/.well-known/openid-configuration</a>.</p>
</blockquote>
<p>Details about the fields in this provider configuration:</p>
<ul>
<li><strong>provider</strong> is used by the loopback-passport-configurator to build a strategy</li>
<li><strong>authScheme</strong> is used by the loopback-passport-configurator to build a strategy</li>
<li><strong>module</strong> describes the passport module to use. passport-openidconnect is already included in the backend</li>
<li><strong>authPath</strong> is the path that the backend will create (with the help of loopback-passport-configurator) to begin the authentication process. The backend will redirect users to this path (once it is configured, of course!)</li>
<li><strong>successRedirect</strong> is the URL passed to the OIDC provider instructing it to redirect the user on success. Here we set it to the a development environment&apos;s user page.</li>
<li><strong>failureRedirect</strong> is the URL passed to the OIDC provider instructing it to redirect the user on failed authentication. Here we set it to the a development environment&apos;s user page login page.</li>
<li><strong>failureFlash</strong> is currently unsupported.</li>
<li><strong>session</strong> is not needed, since the frontend authenticates outside of sessions.</li>
<li><strong>authorizationURL</strong> is specific to your OIDC provider</li>
<li><strong>tokenURL</strong> is specific to your OIDC provider</li>
<li><strong>userInfoURL</strong> is specific to your OIDC provider</li>
<li><strong>clientID</strong> is specific to your OIDC provider</li>
<li><strong>clientSecret</strong> is specific to your OIDC provider</li>
<li><strong>scope</strong> is specific to your OIDC provider</li>
<li><strong>loginCallback</strong> optional name of a <a href="#configure-callback">callback</a> function to run to add profile information to the UserIdentity</li>
</ul>
<h4 id="session-secret">Session Secret</h4>
<p>The nodejs module <code>passport-openidconnect</code> requires the use of the <code>express-session</code> module
to create a login session for the user.
 This requires a <em>session secret</em> to be configured in <code>config.local.js</code>:</p>
<pre><code> module.exports = {
  expressSessionSecret: &quot;thisIsSuperSecretForUserSession&quot;
</code></pre><h2 id="scicat-frontend-configuration">SciCat Frontend Configuration</h2>
<p>The default login page in the frontend provides a username/password form that is used both for local and LDAP/AD authentication. When using and OIDC authentication provider, SciCat will not ask the user for credential directly. Instead, the user will be redirected to the OIDC provider to authenticate. So, the frontend provides two configuration settings to modify the login page appropriately.</p>
<p>These setting are accomplished by modifying the frontend <a href="Environment.md">environment document</a>. </p>
<pre><code class="lang-javascript">
  <span class="hljs-attr">loginFormEnabled</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">oAuth2Endpoints</span>: [
    {<span class="hljs-attr">displayText</span>: <span class="hljs-string">&quot;Google&quot;</span>, <span class="hljs-attr">displayImage</span>: <span class="hljs-string">&quot;../../../assets/images/btn_google_light_normal_ios.svg&quot;</span>, <span class="hljs-attr">authURL</span>: <span class="hljs-string">&quot;auth/google&quot;</span>}]
</code></pre>
<ul>
<li><strong>loginFormEnabled</strong> sets whether to display the username/password form in the login page</li>
<li><strong>oAuth2Endpoints</strong> provides information that the frontend uses to display &quot;Sign in with ...&quot; buttons. Note that this is an array, multiple buttons for multiple OIDC providers can be configured.<ul>
<li><strong>displayText</strong> sets the name of the provider to display in the button. In this case, the button will show &quot;Sign In With Google&quot;</li>
<li><strong>displayImage</strong> defines an image to display in the button. The image will end up being 24px tall. It is recommended that the image be in SVG format.</li>
<li><strong>authURL</strong> defines the relative path that the user will be redirected to when they click the button. Note that this maps to the <code>authPath</code> setting described above.</li>
</ul>
</li>
</ul>
<h2 id="backend-code-hooks">Backend Code Hooks</h2>
<p>Configuring backend and frontend to authenticate through OIDC is very useful for providing a third party authentication. However, there two issues that come up that can be addressed with backend code hooks:</p>
<ul>
<li>By default, the system will authenticate all users who pass come in through the OAuth Provider. </li>
<li>By default, the users profile in the application will contain information gathered from the OAuth Provider, and nothing more.</li>
</ul>
<h3 id="prevent-authenticating-unkown-users">Prevent Authenticating Unkown Users</h3>
<p>In <a href="#backend-configuration">Backend Configuration</a>, we configured the loginCallback. The value of this file is the name of a function that must be defined and exported. See <a href="https://github.com/SciCatProject/backend/blob/develop/server/boot/login-callbacks.js" target="_blank">login-call.js</a> for details.</p>
<p>Code snippet is presented for as an example, omitting the particular details about communicating with an external system:</p>
<pre><code class="lang-javascript">
<span class="hljs-built_in">module</span>.exports.sampleLoginCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, done</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user, identity, token</span>) </span>{

    <span class="hljs-keyword">var</span> authInfo = {
      <span class="hljs-attr">identity</span>: identity,
    };
    <span class="hljs-keyword">if</span> (token) {
      authInfo.accessToken = token;
    }

    <span class="hljs-keyword">const</span> requestURL = getUserURL(identity);
    <span class="hljs-keyword">if</span> (!requestURL){
      logger.logError(<span class="hljs-string">`unexpected authenticator type: <span class="hljs-subst">${identity.provider}</span>`</span>);
      done();
      <span class="hljs-keyword">return</span>;
    }
    request(requestURL, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, response, body</span>) </span>{
      <span class="hljs-comment">// ask external system for the user&apos;s profile information</span>
      <span class="hljs-keyword">if</span> (error){
        <span class="hljs-comment">// and error occurred talking to the external system (possibly from a connection issue)...deny login</span>
        logger.logError(<span class="hljs-string">`error talking to external <span class="hljs-subst">${error.message}</span>`</span>);
        done(err, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (response.statusCode == <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">const</span> bodyObj = <span class="hljs-built_in">JSON</span>.parse(body);
        logger.logInfo(<span class="hljs-string">&quot;user service returned&quot;</span>, bodyObj);
      }
      <span class="hljs-keyword">else</span>{
        logger.logError(<span class="hljs-string">`external system replied with an error <span class="hljs-subst">${response.statusCode}</span> - <span class="hljs-subst">${body}</span>.`</span>);
        <span class="hljs-comment">// external system replied with a negative response...deny login</span>
        done(err, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-comment">//accept login</span>
      done(err, user, authInfo);
    });
  };
};
</code></pre>
<h3 id="add-information-to-users-profile">Add information to User&apos;s Profile</h3>
<p>By default profile information from the Authentication Provider will be added to the user&apos;s profile. This profile is stored in the DaCat database <code>UserIdentity</code> collection. This collection is created by the loopback-component-passport library, and is also used for LDAP authentication. The backend LDAP integrations populate this collection with the user&apos;s LDAP profile information automatically with a callback. One of the most important things that is added to the profile is the user&apos;s accessGroups field, which is critical to calculating a user&apos;s privilege in SciCat.</p>
<p>One way to mimic this with an OAuth2 provider is to use a <code>before save</code> <a href="https://loopback.io/doc/en/lb3/Operation-hooks.html" target="_blank">Loopback Operation Hook</a>. This hook will get called as the user logs in and allows you to add information to the <code>UserIdentity</code> collection, which will be used in a variety of places, including access controls.</p>
<p>The following code snippet is presented for as an example, omitting the particular details about communicating with an external system:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Observe saving UserIdentity. This gives us the ability to update the user profile with facility-specific groups</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
  app.models.UserIdentity.observe(<span class="hljs-string">&quot;before save&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctx, next</span>) </span>{
    <span class="hljs-keyword">if</span> (!ctx.data){
      logger.logInfo(<span class="hljs-string">&quot;No context data from UserIdentity&quot;</span>);
      next();
      <span class="hljs-keyword">return</span>;
    }
    request(userURL, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, response, _body</span>) </span>{
      <span class="hljs-comment">// ask external system for user information so we can get group info</span>
      <span class="hljs-keyword">if</span> (error){
        logger.logError(<span class="hljs-string">`error talking to external system <span class="hljs-subst">${error.message}</span>`</span>);
        next();
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (response.statusCode == <span class="hljs-number">200</span>){
        <span class="hljs-comment">// add groups to profile, saving in the UserIdentity model</span>
        ctx.data.profile.accessGroups = <span class="hljs-built_in">JSON</span>.parse(response.body).groups;
      }
      next();
    });
  });
};
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Login.html" class="navigation navigation-prev " aria-label="Previous page: Login and Accounts">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Ngrx.html" class="navigation navigation-next " aria-label="Next page: State Management in Angular">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"OIDC Integration","level":"1.5.1.7","depth":3,"next":{"title":"State Management in Angular","level":"1.5.1.8","depth":3,"path":"Development/v3.x/Ngrx.md","ref":"Development/v3.x/Ngrx.md","articles":[]},"previous":{"title":"Login and Accounts","level":"1.5.1.6","depth":3,"path":"Development/v3.x/Login.md","ref":"Development/v3.x/Login.md","articles":[]},"dir":"ltr"},"config":{"plugins":["chapter-fold"],"styles":{"website":"styles/website.css"},"pluginsConfig":{"chapter-fold":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"SciCat Documentation","gitbook":"*"},"file":{"path":"Development/v3.x/OIDC.md","mtime":"2023-10-26T09:34:50.698Z","type":"markdown"},"gitbook":{"version":"3.7.5","time":"2023-10-26T09:35:02.431Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

